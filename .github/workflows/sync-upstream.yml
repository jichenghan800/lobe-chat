name: Sync Upstream

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  check_and_sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }} # å¿…é¡»ä½¿ç”¨ PAT ä»¥è§¦å‘åç»­çš„ Release Workflow

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check latest upstream version
        id: check
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° release tag
          UPSTREAM_TAG=$(curl -sSL https://api.github.com/repos/lobehub/lobe-chat/releases/latest | jq -r '.tag_name')
          echo "Upstream tag: $UPSTREAM_TAG"
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¯¥ tag (å³ä½¿æˆ‘ä»¬ä¸æ¨ tagï¼Œä½œä¸ºä¸€ä¸ªæ£€æµ‹æœºåˆ¶ä¹Ÿå¯ä»¥ç”¨)
          # æˆ–è€…æ›´ç®€å•çš„ï¼šæ£€æŸ¥ package.json ç‰ˆæœ¬æ˜¯å¦å·²è½å TODO
          # è¿™é‡Œé‡‡ç”¨ç®€å•çš„ Tag æ¯”è¾ƒé€»è¾‘
          
          if git rev-parse "$UPSTREAM_TAG" >/dev/null 2>&1; then
            echo "Already synced with $UPSTREAM_TAG"
            echo "has_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "New version detected: $UPSTREAM_TAG"
            echo "tag=$UPSTREAM_TAG" >> "$GITHUB_OUTPUT"
            echo "has_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Sync and Merge
        if: steps.check.outputs.has_update == 'true'
        id: merge
        run: |
          TAG="${{ steps.check.outputs.tag }}"
          BRANCH="sync/$TAG"
          
          git remote add upstream https://github.com/lobehub/lobe-chat.git
          git fetch upstream --tags -f
          
          # åŸºäºå½“å‰ main åˆ›å»ºåŒæ­¥åˆ†æ”¯
          git checkout -b "$BRANCH" main
          
          # å°è¯•åˆå¹¶ä¸Šæ¸¸ Tag
          # ä½¿ç”¨ --no-edit è‡ªåŠ¨æäº¤åˆå¹¶ä¿¡æ¯
          # é‡ç‚¹ï¼šå¤„ç† lockfile å†²çªé£é™©ã€‚
          # ç­–ç•¥ï¼šå¦‚æœ automatic merge å¤±è´¥ï¼Œè„šæœ¬ä¼šæŠ¥é”™å¹¶åœ¨ä¸‹ä¸€æ­¥åˆ›å»º issue é€šçŸ¥äººå·¥å¤„ç†
          if git merge upstream/"$TAG" --no-edit; then
            echo "Merge successful"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
            echo "success=true" >> "$GITHUB_OUTPUT"
          else
            echo "Merge conflict detected"
            git merge --abort
            echo "success=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_update == 'true' && steps.merge.outputs.success == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT }}
          branch: ${{ steps.merge.outputs.branch }}
          base: main
          title: 'cb: sync upstream release ${{ steps.check.outputs.tag }}'
          body: |
            ## ğŸ”„ åŒæ­¥ä¸Šæ¸¸ç‰ˆæœ¬ ${{ steps.check.outputs.tag }}
            
            æ£€æµ‹åˆ° LobeChat å®˜æ–¹å‘å¸ƒäº†æ–°ç‰ˆæœ¬ã€‚
            æ­¤ PR å·²è‡ªåŠ¨åˆå¹¶ä¸Šæ¸¸ä»£ç ï¼ŒåŒ…å«å®˜æ–¹æ›´æ–° + ä½ çš„æœ¬åœ°ä¿®æ”¹ã€‚
            
            âœ… **è¯·æ£€æŸ¥ CI é€šè¿‡åå†åˆå¹¶ã€‚**
          labels: 'sync, upstream'

      - name: Create Conflict Issue
        if: steps.check.outputs.has_update == 'true' && steps.merge.outputs.success == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å†²çªé€šçŸ¥: ${{ steps.check.outputs.tag }}'
          body: |
            åœ¨å°è¯•è‡ªåŠ¨åˆå¹¶ä¸Šæ¸¸ç‰ˆæœ¬ `${{ steps.check.outputs.tag }}` æ—¶å‘ç”Ÿä»£ç å†²çªã€‚
            è¯·æ‰‹åŠ¨åœ¨æœ¬åœ°æ‹‰å– `upstream` å¹¶è§£å†³å†²çªã€‚
