name: Release Custom Version

permissions:
  contents: write
  id-token: write # ç”¨äºå¯èƒ½çš„ Docker æ„å»ºæˆ–å…¶ä»–èº«ä»½éªŒè¯

on:
  push:
    branches:
      - main
    paths:
      - 'package.json' # åªæœ‰å½“ç‰ˆæœ¬å·æ–‡ä»¶å˜åŠ¨æ—¶æ‰è§¦å‘æ£€æµ‹

jobs:
  check_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }} # ç”¨äºæ¨é€ Tag å’Œåˆ›å»º Release

      - name: Read Version from package.json
        id: version
        run: |
          # è¯»å– package.json ä¸­çš„ version å­—æ®µ
          VERSION=$(jq -r .version package.json)
          # æ„é€  v å‰ç¼€çš„ tagï¼Œä¾‹å¦‚ v1.19.0
          TAG_NAME="v$VERSION"
          echo "Current version: $TAG_NAME"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: Check if Release Exists
        id: check_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag_name }}"
          # æ£€æŸ¥è¿™ä¸ª tag æ˜¯å¦å·²ç»å­˜åœ¨äºè¿œç¨‹
          if git ls-remote --exit-code --tags origin "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping release."
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Tag $TAG does not exist. Proceeding to release."
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG="${{ steps.version.outputs.tag_name }}"
          git tag -a "$TAG" -m "Release $TAG (Custom Build)"
          git push origin "$TAG"

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.PAT }}
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ${{ steps.version.outputs.tag_name }} 
          body: |
            ## ğŸš€ Custom Release ${{ steps.version.outputs.tag_name }}
            
            åŸºäºå®˜æ–¹ç‰ˆæœ¬æ„å»ºï¼ŒåŒ…å«ä»¥ä¸‹è‡ªå®šä¹‰ä¿®æ”¹ã€‚
            
            Synced from upstream.
          draft: false
          prerelease: false
          generate_release_notes: true # è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿—ï¼ˆåŸºäºä½ çš„ commit å†å²ï¼‰
