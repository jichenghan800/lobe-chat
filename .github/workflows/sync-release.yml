name: Sync Upstream Release

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest upstream release tag
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          api="https://api.github.com/repos/lobehub/lobe-chat/releases/latest"
          resp=$(curl -sSL -H "Authorization: Bearer $GH_TOKEN" "$api")
          tag=$(echo "$resp" | jq -r '.tag_name // empty')

          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "Error: Cannot fetch latest release tag" && exit 1
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "safe_tag=$(echo "$tag" | tr '/' '-')" >> "$GITHUB_OUTPUT"

      - name: Prepare merge
        id: merge
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/lobehub/lobe-chat.git
          git fetch upstream --tags -f 

          tag="${{ steps.release.outputs.tag }}"
          
          # === å…³é”®ä¿®æ”¹ ===
          # å³ä½¿ Tag å­˜åœ¨ï¼Œä¹Ÿä¸ç›´æ¥ exit 0ï¼Œè€Œæ˜¯æ ‡è®°çŠ¶æ€ä¾›åç»­åˆ¤æ–­
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists locally."
            echo "up_to_date=true" >> "$GITHUB_OUTPUT"
            # æ—¢ç„¶ Tag éƒ½åœ¨äº†ï¼Œå°±ä¸éœ€è¦å† checkout å’Œ merge äº†
          else
            # Tag ä¸å­˜åœ¨ï¼Œæ­£å¸¸æ‰§è¡Œåˆå¹¶æµç¨‹
            branch="sync/release-${{ steps.release.outputs.safe_tag }}"
            git checkout -b "$branch"
  
            if ! git merge --no-ff "$tag" -m "chore: sync upstream release $tag"; then
              echo "conflict=true" >> "$GITHUB_OUTPUT"
              git merge --abort || true
              exit 0
            fi
            
            echo "branch=$branch" >> "$GITHUB_OUTPUT"
            echo "up_to_date=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        id: pr
        # åªæœ‰åœ¨ä»£ç çœŸçš„æœ‰æ›´æ–°ï¼ˆé up_to_dateï¼‰æ—¶æ‰å‘ PR
        if: steps.merge.outputs.up_to_date == 'false' && steps.merge.outputs.conflict != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.merge.outputs.branch }}
          base: main
          title: 'chore: sync upstream release ${{ steps.release.outputs.tag }}'
          delete-branch: true
          body: |
            ## â¬†ï¸ ä¸Šæ¸¸æ–°ç‰ˆæœ¬åŒæ­¥
            æ£€æµ‹åˆ°ä¸Šæ¸¸å‘å¸ƒäº†æ–°ç‰ˆæœ¬ `${{ steps.release.outputs.tag }}`ã€‚
            æœ¬ PR å·²è‡ªåŠ¨å®Œæˆä»£ç åˆå¹¶ã€‚

      - name: Force Sync Tag to Origin
        # åªè¦æ²¡æœ‰å†²çªï¼Œå§‹ç»ˆç¡®ä¿ Tag è¢«åŒæ­¥åˆ°è¿œç¨‹ï¼ˆé˜²æ­¢æœ¬åœ°æœ‰ä½†è¿œç¨‹æ²¡æœ‰çš„æƒ…å†µï¼‰
        if: steps.merge.outputs.conflict != 'true'
        run: |
          git push origin ${{ steps.release.outputs.tag }} --force

      - name: Create GitHub Release
        # === å…³é”®ä¿®æ”¹ ===
        # åªè¦æ²¡æœ‰å†²çªï¼Œå§‹ç»ˆå°è¯•å‘å¸ƒ Releaseï¼ˆè¡¥å‘æˆ–æ›´æ–°ï¼‰
        if: steps.merge.outputs.conflict != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: ${{ steps.release.outputs.tag }}
          body: |
            Sync from upstream ${{ steps.release.outputs.tag }}.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create conflict issue
        if: steps.merge.outputs.conflict == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å†²çª: ${{ steps.release.outputs.tag }}'
          body: |
            è‡ªåŠ¨åˆå¹¶ä¸Šæ¸¸ç‰ˆæœ¬ `${{ steps.release.outputs.tag }}` æ—¶äº§ç”Ÿå†²çªã€‚
