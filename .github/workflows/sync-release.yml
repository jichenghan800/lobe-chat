name: Sync Upstream Release

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  sync_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # å¿…é¡»æ‹‰å–æ‰€æœ‰æ ‡ç­¾ä»¥ä¾›åç»­åˆ¤å®š
          fetch-tags: true 

      - name: Get latest upstream release tag
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # ä¾ç„¶ä½¿ç”¨ /tags æ¥å£ç¡®ä¿è·å–æœ€åŠæ—¶çš„ç‰ˆæœ¬
          api="https://api.github.com/repos/lobehub/lobe-chat/tags?per_page=1"
          resp=$(curl -sSL -H "Authorization: Bearer $GH_TOKEN" "$api")
          tag=$(echo "$resp" | jq -r '.[0].name // empty')

          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "Error: Cannot fetch tag" && exit 1
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "safe_tag=$(echo "$tag" | tr '/' '-')" >> "$GITHUB_OUTPUT"

      - name: Prepare merge
        id: merge
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/lobehub/lobe-chat.git
          
          # å…³é”®ç‚¹ 1ï¼šå¼ºåˆ¶åˆ·æ–°ä¸Šæ¸¸æ ‡ç­¾ï¼Œè§£å†³ clobber é—®é¢˜
          git fetch upstream --tags -f 
          git fetch origin main

          tag="${{ steps.release.outputs.tag }}"
          
          # å…³é”®ç‚¹ 2ï¼šä¼˜åŒ–åˆ¤å®šé€»è¾‘
          # å¦‚æœå½“å‰ main åˆ†æ”¯çš„æè¿°å·²ç»åŒ…å«è¿™ä¸ª tagï¼Œè¯´æ˜å·²ç»åŒæ­¥è¿‡äº†
          if git describe --tags --always | grep -q "$tag"; then
            echo "up_to_date=true" >> "$GITHUB_OUTPUT"
            echo "Current HEAD is already at or past $tag. Skipping..."
            exit 0
          fi

          branch="sync/release-${{ steps.release.outputs.safe_tag }}"
          git branch -D "$branch" || true
          git checkout -b "$branch"

          # å°è¯•éä¾µå…¥å¼åˆå¹¶
          if ! git merge --no-ff "$tag" -m "chore: sync upstream release $tag"; then
            echo "conflict=true" >> "$GITHUB_OUTPUT"
            git merge --abort || true
            exit 0
          fi

          echo "branch=$branch" >> "$GITHUB_OUTPUT"
          echo "up_to_date=false" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        id: pr
        if: steps.merge.outputs.up_to_date != 'true' && steps.merge.outputs.conflict != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.merge.outputs.branch }}
          base: main
          title: 'chore: sync upstream release ${{ steps.release.outputs.tag }}'
          delete-branch: true
          body: |
            å·²æ£€æµ‹åˆ°ä¸Šæ¸¸æ–°ç‰ˆæœ¬ `${{ steps.release.outputs.tag }}`ã€‚
            æ­¤ PR è‡ªåŠ¨å°†ä¸Šæ¸¸ä»£ç åˆå¹¶è‡³å½“å‰äºŒå¼€åˆ†æ”¯ã€‚

      - name: Force Sync Tag to Origin
        if: steps.merge.outputs.up_to_date != 'true' && steps.merge.outputs.conflict != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å…³é”®ç‚¹ 3ï¼šå¼ºåˆ¶å°†æ­£ç¡®çš„ä¸Šæ¸¸æ ‡ç­¾æ¨é€åˆ°ä½ çš„ origin
          # è§£å†³ä½ ä¹‹å‰æåˆ°çš„â€œæœ¬åœ°æ²¡ç”Ÿæˆ releaseâ€æˆ–æ ‡ç­¾æŒ‡å‘é”™è¯¯çš„é—®é¢˜
          git push origin ${{ steps.release.outputs.tag }} --force

      - name: Create conflict issue
        if: steps.merge.outputs.conflict == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ Sync Conflict: ${{ steps.release.outputs.tag }}'
          body: 'è‡ªåŠ¨åˆå¹¶ä¸Šæ¸¸ç‰ˆæœ¬æ—¶äº§ç”Ÿå†²çªï¼Œè¯·åœ¨æœ¬åœ°æ‰‹åŠ¨æ‰§è¡Œ `git merge ${{ steps.release.outputs.tag }}`ã€‚'
