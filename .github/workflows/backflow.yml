name: Backflow Main -> Dev

permissions:
  contents: write
  issues: write

on:
  push:
    branches:
      - main  # ç›‘å¬ main çš„å˜åŠ¨ï¼ˆåŒ…æ‹¬ä¸Šæ¸¸åŒæ­¥ å’Œ ä½ çš„å‘ç‰ˆï¼‰
  workflow_dispatch:

# ğŸ”’ å¹¶å‘æ§åˆ¶ï¼šå¦‚æœä¸Šæ¸¸è¿ç»­æ›´æ–°ï¼Œåªè¿è¡Œæœ€æ–°çš„ä¸€ä¸ªï¼Œé¿å… dev åˆ†æ”¯è¢«å¤šçº¿ç¨‹å†™å
concurrency:
  group: backflow-main-dev
  cancel-in-progress: true

jobs:
  sync_back:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev             # <--- ä¿®æ­£ç‚¹1ï¼šç›´æ¥åˆ‡åˆ°ç›®æ ‡åˆ†æ”¯ dev
          fetch-depth: 0       # <--- ä¿®æ­£ç‚¹2ï¼šæŠ“å–å®Œæ•´å†å²ï¼Œå¦åˆ™æ— æ³• merge
          token: ${{ secrets.PAT }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge Main into Dev
        id: merge
        run: |
          # ä¿®æ­£ç‚¹3ï¼šæ˜¾å¼è·å–ä¸¤ä¸ªåˆ†æ”¯çš„æœ€æ–°çŠ¶æ€
          git fetch origin main dev --tags
          
          # ç¡®ä¿å½“å‰å°±åœ¨ dev åˆ†æ”¯ä¸”æ˜¯å¹²å‡€çš„
          git checkout dev
          git reset --hard origin/dev

          echo "ğŸ¦ Trying to merge main into dev..."
          
          # å°è¯•åˆå¹¶ (main -> dev)
          if git merge origin/main --no-edit; then
            echo "âœ… Merge successful."
            git push origin dev
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Merge conflict detected."
            # é‡åˆ°å†²çªç«‹åˆ»åœæ­¢ï¼Œä¸äº§ç”Ÿè„ä»£ç 
            git merge --abort
            echo "status=conflict" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Conflict Issue
        if: steps.merge.outputs.status == 'conflict'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          token: ${{ secrets.PAT }}
          title: 'ğŸš¨ åŒæ­¥å¤±è´¥: Main -> Dev å†²çªè­¦å‘Š'
          body: |
            ### âš ï¸ è‡ªåŠ¨å›æµå¤±è´¥

            `main` åˆ†æ”¯æœ‰æ›´æ–°ï¼Œä½†åœ¨å°è¯•è‡ªåŠ¨åˆå¹¶åˆ° `dev` æ—¶å‘ç”Ÿäº†ä»£ç å†²çªã€‚

            **è¿™æ„å‘³ç€ä½ çš„ `dev` ç¯å¢ƒå·²ç»ä¸å†åŒ…å«æœ€æ–°çš„å®˜æ–¹ä¿®è¡¥ã€‚**

            #### è¯·ç«‹å³é‡‡å–è¡ŒåŠ¨ï¼š
            1. åœ¨æœ¬åœ°æ‹‰å–æœ€æ–°ä»£ç : `git checkout dev && git pull`
            2. æ‰‹åŠ¨åˆå¹¶ main: `git merge main`
            3. åœ¨ IDE ä¸­è§£å†³å†²çªå¹¶æäº¤æ¨é€ã€‚
          labels: 'conflict, help wanted'
